# 快速配置部署指南

## 🎯 当前状态

✅ CI/CD 已配置完成
✅ 代码检查和构建功能已启用
⏭️ 部署功能已禁用(需要手动启用)

## 📝 为什么部署被跳过?

部署需要服务器凭证(SSH 密钥、服务器地址等敏感信息)。为了安全,这些信息需要您手动配置。

在配置完成之前,GitHub Actions 会:

- ✅ 自动运行代码检查
- ✅ 自动构建应用
- ✅ 上传构建产物(可下载)
- ⏭️ 跳过部署步骤

## 🚀 快速启用部署(3 步)

### 步骤 1: 生成 SSH 密钥

在本地终端执行:

```bash
# 生成 SSH 密钥对
ssh-keygen -t rsa -b 4096 -C "github-deploy" -f ~/.ssh/github_deploy -N ""

# 查看私钥(复制整个内容,包括 BEGIN 和 END 行)
cat ~/.ssh/github_deploy

# 查看公钥
cat ~/.ssh/github_deploy.pub
```

### 步骤 2: 配置服务器

将公钥添加到服务器:

```bash
# 登录到服务器
ssh user@your-server.com

# 添加公钥到 authorized_keys
mkdir -p ~/.ssh
echo "你的公钥内容" >> ~/.ssh/authorized_keys

# 设置权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

# 创建部署目录
sudo mkdir -p /var/www/your-app
sudo chown $USER:$USER /var/www/your-app
```

### 步骤 3: 配置 GitHub Secrets

1. **进入 GitHub 仓库页面**

   ```
   https://github.com/你的用户名/你的仓库名/settings/secrets/actions
   ```

2. **添加 Variable (启用部署)**

   点击 "Variables" 标签 → "New repository variable"

   ```
   Name: ENABLE_DEPLOY
   Value: true
   ```

3. **添加 Secrets (测试环境)**

   点击 "Secrets" 标签 → "New repository secret"

   添加以下 4 个 Secrets:

   ```
   Name: TEST_SSH_PRIVATE_KEY
   Value: [步骤1中的私钥内容]

   Name: TEST_REMOTE_HOST
   Value: [服务器地址,如: test.example.com]

   Name: TEST_REMOTE_USER
   Value: [服务器用户名,如: deploy]

   Name: TEST_REMOTE_TARGET
   Value: [部署目录,如: /var/www/test-app]
   ```

4. **添加 Secrets (生产环境,可选)**

   如果需要生产环境部署,再添加:

   ```
   PROD_SSH_PRIVATE_KEY
   PROD_REMOTE_HOST
   PROD_REMOTE_USER
   PROD_REMOTE_TARGET
   ```

## ✅ 验证配置

配置完成后,推送代码测试:

```bash
# 推送到 develop 分支(测试环境)
git checkout develop
git push origin develop

# 或推送到 main 分支(生产环境)
git checkout main
git push origin main
```

查看 GitHub Actions 页面,部署工作流应该会执行。

## 🔍 检查部署结果

### 在 GitHub 上查看

1. 进入仓库的 Actions 页面
2. 点击最新的工作流运行
3. 查看 "部署到测试环境" 或 "部署到生产环境" 任务
4. 查看日志确认部署成功

### 在服务器上查看

```bash
# SSH 登录服务器
ssh user@your-server.com

# 查看部署目录
ls -la /var/www/your-app

# 应该看到:
# - index.html
# - js/
# - css/
# - assets/
```

## 🎨 仅需要构建,不需要部署?

如果您只想使用 CI 进行代码检查和构建,不需要自动部署:

**不需要做任何配置!**

默认情况下:

- ✅ 每次推送都会自动检查代码
- ✅ 每次推送都会自动构建
- ✅ 构建产物会上传到 GitHub Actions
- ✅ 可以手动下载构建产物部署

## 📥 手动下载构建产物

1. 进入 GitHub Actions 页面
2. 点击任意成功的工作流运行
3. 滚动到页面底部 "Artifacts" 部分
4. 下载对应环境的构建产物:
   - `build-development`
   - `build-test`
   - `build-production`

## 🆘 遇到问题?

### 问题 1: 部署失败 - SSH 连接错误

**检查清单:**

- [ ] 私钥格式正确(包含 BEGIN 和 END 行)
- [ ] 公钥已添加到服务器 `~/.ssh/authorized_keys`
- [ ] 服务器 SSH 权限正确(700 for .ssh, 600 for authorized_keys)
- [ ] 服务器地址和用户名正确

### 问题 2: 部署失败 - 权限错误

**解决方案:**

```bash
# 在服务器上设置部署目录权限
sudo chown -R 部署用户:部署用户 /var/www/your-app
sudo chmod -R 755 /var/www/your-app
```

### 问题 3: 构建成功但部署被跳过

**原因:** 未配置 `ENABLE_DEPLOY` 变量

**解决方案:**

```
Settings → Secrets and variables → Actions → Variables
添加: ENABLE_DEPLOY = true
```

## 📚 更多信息

详细配置说明请查看: [CI/CD 配置指南](./CICD配置指南.md)

## 🎉 配置完成

恭喜!您的 CI/CD 流程已经配置完成。现在每次推送代码都会:

1. ✅ 自动检查代码质量
2. ✅ 自动运行类型检查
3. ✅ 自动构建应用
4. ✅ 自动部署到服务器(如果已配置)
5. ✅ 发送部署通知(如果已配置 Slack)

享受自动化带来的便利吧! 🚀
