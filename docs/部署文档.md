# éƒ¨ç½²æ–‡æ¡£

## ğŸ“¦ æ„å»ºæµç¨‹

### æ„å»ºæ‰€æœ‰åº”ç”¨

```bash
# æ„å»ºæ‰€æœ‰åº”ç”¨
pnpm run build:all

# æ„å»ºæŒ‡å®šåº”ç”¨
pnpm run build                # ä¸»åº”ç”¨
pnpm --filter account build   # è´¦å·ä¸­å¿ƒ
pnpm --filter designer build  # è®¾è®¡å™¨
pnpm --filter renderer build  # æ¸²æŸ“å™¨
pnpm --filter admin build     # ç®¡ç†åå°
```

### æ„å»º npm åŒ…

```bash
# æ„å»ºè®¤è¯åŒ…
cd @cwj/auth
pnpm run build
pnpm publish --access restricted

# æ„å»º UI ç»„ä»¶åº“
cd @cwj/ui-pc
pnpm run build
pnpm publish --access restricted

# æ„å»ºå·¥å…·åº“
cd @cwj/tools
pnpm run build
pnpm publish --access restricted
```

## ğŸ“‚ æ„å»ºäº§ç‰©

### äº§ç‰©ç›®å½•ç»“æ„

```
public/apps/
â”œâ”€â”€ root/                # ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ remoteEntry.js
â”‚   â””â”€â”€ assets/
â”œâ”€â”€ account/             # è´¦å·ä¸­å¿ƒ
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ assets/
â”œâ”€â”€ designer/            # è®¾è®¡å™¨
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ remoteEntry.js
â”‚   â””â”€â”€ assets/
â”œâ”€â”€ renderer/            # æ¸²æŸ“å™¨
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ remoteEntry.js
â”‚   â””â”€â”€ assets/
â”œâ”€â”€ admin/               # ç®¡ç†åå°
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ remoteEntry.js
â”‚   â””â”€â”€ assets/
â””â”€â”€ docs/                # æ–‡æ¡£ç«™ç‚¹
    â”œâ”€â”€ auth/
    â”œâ”€â”€ ui/
    â””â”€â”€ tools/
```

### äº§ç‰©è¯´æ˜

| åº”ç”¨       | äº§ç‰©è·¯å¾„             | è¯´æ˜                |
| ---------- | -------------------- | ------------------- |
| ä¸»åº”ç”¨     | public/apps/root     | åŒ…å« remoteEntry.js |
| Account    | public/apps/account  | ç‹¬ç«‹ç«™ç‚¹            |
| Designer   | public/apps/designer | åŒ…å« remoteEntry.js |
| Renderer   | public/apps/renderer | åŒ…å« remoteEntry.js |
| Admin      | public/apps/admin    | åŒ…å« remoteEntry.js |
| @cwj/auth  | npm åŒ…               | å‘å¸ƒåˆ°ç§æœ‰ npm ä»“åº“ |
| @cwj/ui-\* | npm åŒ…               | å‘å¸ƒåˆ°ç§æœ‰ npm ä»“åº“ |
| @cwj/tools | npm åŒ…               | å‘å¸ƒåˆ°ç§æœ‰ npm ä»“åº“ |

## ğŸŒ Nginx é…ç½®

### ä¸»ç«™ç‚¹é…ç½®

```nginx
# /etc/nginx/conf.d/main.conf
server {
    listen 80;
    server_name xx.xxx.com;

    # å¯ç”¨ gzip å‹ç¼©
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_min_length 1000;

    # ä¸»åº”ç”¨
    location / {
        root /var/www/apps/root;
        try_files $uri $uri/ /index.html;

        # ç¼“å­˜ç­–ç•¥
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # è´¦å·ä¸­å¿ƒ
    location /account/ {
        alias /var/www/apps/account/;
        try_files $uri $uri/ /account/index.html;
    }

    # è®¾è®¡å™¨
    location /designer/ {
        alias /var/www/apps/designer/;
        try_files $uri $uri/ /designer/index.html;
    }

    # æ¸²æŸ“å™¨
    location /renderer/ {
        alias /var/www/apps/renderer/;
        try_files $uri $uri/ /renderer/index.html;
    }

    # ç®¡ç†åå°
    location /admin/ {
        alias /var/www/apps/admin/;
        try_files $uri $uri/ /admin/index.html;
    }

    # Auth æ–‡æ¡£
    location /auth/ {
        alias /var/www/apps/docs/auth/;
        try_files $uri $uri/ /auth/index.html;
    }

    # UI æ–‡æ¡£
    location /ui/ {
        alias /var/www/apps/docs/ui/;
        try_files $uri $uri/ /ui/index.html;
    }

    # Tools æ–‡æ¡£
    location /tools/ {
        alias /var/www/apps/docs/tools/;
        try_files $uri $uri/ /tools/index.html;
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://backend-server:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### HTTPS é…ç½®

```nginx
server {
    listen 443 ssl http2;
    server_name xx.xxx.com;

    # SSL è¯ä¹¦
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # SSL é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # å…¶ä»–é…ç½®åŒä¸Š...
}

# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name xx.xxx.com;
    return 301 https://$server_name$request_uri;
}
```

## ğŸ³ Docker éƒ¨ç½²

### Dockerfile

```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM node:16-alpine AS builder

# å®‰è£… pnpm
RUN npm install -g pnpm

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY @cwj/*/package.json @cwj/*/

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»º
RUN pnpm run build:all

# ç”Ÿäº§é•œåƒ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/public/apps /usr/share/nginx/html

# å¤åˆ¶ Nginx é…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨ Nginx
CMD ["nginx", "-g", "daemon off;"]
```

### docker-compose.yml

```yaml
version: '3.8'

services:
  frontend:
    build: .
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./ssl:/etc/nginx/ssl
    environment:
      - NODE_ENV=production
    restart: unless-stopped

  backend:
    image: backend-server:latest
    ports:
      - '8080:8080'
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/dbname
    restart: unless-stopped

  db:
    image: postgres:14-alpine
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=dbname
    restart: unless-stopped

volumes:
  postgres-data:
```

### æ„å»ºå’Œè¿è¡Œ

```bash
# æ„å»ºé•œåƒ
docker build -t lowcode-platform:latest .

# è¿è¡Œå®¹å™¨
docker run -d -p 80:80 -p 443:443 lowcode-platform:latest

# ä½¿ç”¨ docker-compose
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f frontend

# åœæ­¢æœåŠ¡
docker-compose down
```

## ğŸš€ CI/CD

### GitHub Actions

åˆ›å»º `.github/workflows/deploy.yml`:

```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm run type-check

      - name: Lint
        run: pnpm run lint

      - name: Build
        run: pnpm run build:all

      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@v2
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          SOURCE: 'public/apps/'
          TARGET: '/var/www/apps/'

      - name: Restart Nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo nginx -t
            sudo systemctl reload nginx
```

### GitLab CI

åˆ›å»º `.gitlab-ci.yml`:

```yaml
stages:
  - install
  - test
  - build
  - deploy

variables:
  NODE_VERSION: '16'

install:
  stage: install
  image: node:${NODE_VERSION}
  script:
    - npm install -g pnpm
    - pnpm install --frozen-lockfile
  cache:
    paths:
      - node_modules/
      - .pnpm-store/

test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - pnpm run type-check
    - pnpm run lint
    - pnpm run test
  dependencies:
    - install

build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - pnpm run build:all
  artifacts:
    paths:
      - public/apps/
    expire_in: 1 week
  dependencies:
    - install
  only:
    - main

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache rsync openssh
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
  script:
    - rsync -avz --delete public/apps/ $REMOTE_USER@$REMOTE_HOST:/var/www/apps/
    - ssh $REMOTE_USER@$REMOTE_HOST "sudo nginx -t && sudo systemctl reload nginx"
  dependencies:
    - build
  only:
    - main
```

## ğŸ”§ ç¯å¢ƒå˜é‡

### ç”Ÿäº§ç¯å¢ƒå˜é‡

åˆ›å»º `.env.production`:

```bash
# API åœ°å€
VITE_API_BASE_URL=https://api.xxx.com

# è®¤è¯æœåŠ¡å™¨
VITE_AUTH_SERVER_URL=https://auth.xxx.com
VITE_CLIENT_ID=production-client-id

# CDN åœ°å€
VITE_CDN_URL=https://cdn.xxx.com

# æ—¥å¿—çº§åˆ«
VITE_LOG_LEVEL=error

# ç›‘æ§
VITE_SENTRY_DSN=https://xxx@sentry.io/xxx
```

### æ³¨å…¥ç¯å¢ƒå˜é‡

ä¸»åº”ç”¨åœ¨ `vite.config.ts` ä¸­:

```typescript
import { defineConfig, loadEnv } from 'vite'

export default defineConfig(({ mode }) => {
  // åŠ è½½ç¯å¢ƒå˜é‡
  const env = loadEnv(mode, process.cwd(), '')
  
  return {
    // Vite è‡ªåŠ¨æ³¨å…¥ VITE_ å¼€å¤´çš„ç¯å¢ƒå˜é‡
    define: {
      // å¯ä»¥æ‰‹åŠ¨å®šä¹‰å…¶ä»–å˜é‡
      __APP_VERSION__: JSON.stringify(process.env.npm_package_version),
    },
  }
})
```

å­åº”ç”¨åœ¨ `webpack.config.ts` ä¸­:

```typescript
import { DefinePlugin } from 'webpack'
import dotenv from 'dotenv'

// åŠ è½½ç¯å¢ƒå˜é‡
const env = dotenv.config({ path: `.env.${process.env.NODE_ENV}` }).parsed

plugins: [
  new DefinePlugin({
    'process.env': JSON.stringify(env),
  }),
]
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### é”™è¯¯ç›‘æ§ (Sentry)

```typescript
// src/main.ts
import * as Sentry from '@sentry/vue'

if (import.meta.env.PROD) {
  Sentry.init({
    app,
    dsn: import.meta.env.VITE_SENTRY_DSN,
    environment: import.meta.env.MODE,
    tracesSampleRate: 1.0,
  })
}
```

### æ—¥å¿—æ”¶é›†

```nginx
# Nginx æ—¥å¿—é…ç½®
access_log /var/log/nginx/access.log combined;
error_log /var/log/nginx/error.log warn;

# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                '"$http_user_agent" "$http_x_forwarded_for"';
```

## ğŸ” å®‰å…¨é…ç½®

### Nginx å®‰å…¨å¤´

```nginx
# å®‰å…¨å¤´
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;

# éšè— Nginx ç‰ˆæœ¬
server_tokens off;
```

### Cookie å®‰å…¨

ç¡®ä¿ Cookie é…ç½®:

```typescript
cookieOptions: {
  domain: '.xxx.com',
  path: '/',
  secure: true,      // HTTPS only
  sameSite: 'Lax',   // é˜²æ­¢ CSRF
  httpOnly: true,    // é˜²æ­¢ XSS (åç«¯è®¾ç½®)
}
```

## ğŸ”„ å›æ»šç­–ç•¥

### ä¿ç•™å†å²ç‰ˆæœ¬

```bash
# éƒ¨ç½²è„šæœ¬
#!/bin/bash

VERSION=$(date +%Y%m%d%H%M%S)
DEPLOY_DIR="/var/www/apps"
BACKUP_DIR="/var/www/backups"

# å¤‡ä»½å½“å‰ç‰ˆæœ¬
cp -r $DEPLOY_DIR $BACKUP_DIR/$VERSION

# éƒ¨ç½²æ–°ç‰ˆæœ¬
rsync -avz --delete public/apps/ $DEPLOY_DIR/

# é‡å¯ Nginx
nginx -t && systemctl reload nginx

# ä¿ç•™æœ€è¿‘ 5 ä¸ªç‰ˆæœ¬
cd $BACKUP_DIR && ls -t | tail -n +6 | xargs rm -rf
```

### å¿«é€Ÿå›æ»š

```bash
# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
#!/bin/bash

VERSION=$1
DEPLOY_DIR="/var/www/apps"
BACKUP_DIR="/var/www/backups"

if [ -d "$BACKUP_DIR/$VERSION" ]; then
    cp -r $BACKUP_DIR/$VERSION/* $DEPLOY_DIR/
    nginx -t && systemctl reload nginx
    echo "å›æ»šåˆ°ç‰ˆæœ¬ $VERSION æˆåŠŸ"
else
    echo "ç‰ˆæœ¬ $VERSION ä¸å­˜åœ¨"
    exit 1
fi
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### CDN é…ç½®

```nginx
# é™æ€èµ„æºä½¿ç”¨ CDN
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Access-Control-Allow-Origin "*";

    # CDN å›æº
    proxy_pass https://cdn.xxx.com;
}
```

### ç¼“å­˜ç­–ç•¥

```nginx
# HTML ä¸ç¼“å­˜
location ~* \.html$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# JS/CSS é•¿æœŸç¼“å­˜
location ~* \.(js|css)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# å›¾ç‰‡ç¼“å­˜
location ~* \.(png|jpg|jpeg|gif|ico|svg)$ {
    expires 30d;
    add_header Cache-Control "public";
}
```

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ä»£ç å·²é€šè¿‡æ‰€æœ‰æµ‹è¯•
- [ ] ä»£ç å·²é€šè¿‡ Lint æ£€æŸ¥
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] SSL è¯ä¹¦å·²é…ç½®
- [ ] Nginx é…ç½®å·²æµ‹è¯•
- [ ] æ•°æ®åº“å·²å¤‡ä»½
- [ ] ç›‘æ§å’Œæ—¥å¿—å·²é…ç½®
- [ ] å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡
- [ ] å·²é€šçŸ¥ç›¸å…³äººå‘˜
- [ ] å·²åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
